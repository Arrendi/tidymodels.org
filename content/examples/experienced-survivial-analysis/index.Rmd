---
title: "Significance of Predictors in Survival Analysis Models"
tags: [rsample, parsnip, tidyposterior]
categories: [model fitting, model comparison]
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  digits = 3,
  collapse = TRUE,
  comment = "#>"
  )
options(digits = 3)
library(survival)
library(tidymodels)
library(tidyposterior)
pkgs <- c("tidymodels", "survival", "tidyposterior")

req_pkgs <- function(x, what = "This article") {
  x <- sort(x)
  x <- paste0("`", x, "`")
  x <- knitr::combine_words(x, and = " and ")
  paste0(
    what,
    " requires that you have the following packages installed: ",
    x, "." 
  )
}

small_session <- function(pkgs = NULL) {
  pkgs <- c(pkgs, "recipes", "parsnip", "tune", "workflows", "dials", "dplyr",
            "broom", "ggplot2", "purrr", "rlang", "rsample", "tibble", 
            "yardstick", "tidymodels")
  pkgs <- unique(pkgs)
  library(sessioninfo)
  library(dplyr)
  sinfo <- sessioninfo::session_info()
  cls <- class(sinfo$packages)
  sinfo$packages <- 
    sinfo$packages %>% 
    dplyr::filter(package %in% pkgs)
  class(sinfo$packages) <- cls
  sinfo
}

theme_set(theme_bw() + theme(legend.position = "top"))
options(width = 100, digits = 3)
```


`r req_pkgs(pkgs)`

# Introduction

In this article, a parametric analysis of censored data is conducted and `rsample` is used to measure the importance of predictors in the model. While there are parametric survival models in `parnsnip`, more development is in the works for survival models.

The data that will be used is the NCCTG lung cancer data contained in the `survival` package:

```{r lung}
library(survival)
str(lung)
```

`status` is an indicator for which patients are censored (`status = 1`) or an actual event (`status = 2`). 

# Fitting different predictor sets

```{r example-model}
lung_spec <- 
  surv_reg(dist = "weibull") %>% 
  set_engine("survival") 

lung_fit <- 
  lung_spec %>% 
  fit(Surv(time, status) ~ ph.ecog + age + strata(sex), data = lung)
tidy(lung_fit)
```

Note that the stratification on gender only affects the scale parameter; the estimates above are from a log-linear model for the scale parameter even though they are listed with the regression variables for the other parameter. `coef()` gives results that are more clear:

```{r coef}
coef(lung_fit$fit)
```

To resample these data, it would be a good idea to try to maintain the same censoring rate across the splits. To do this, stratified resampling can be used where each analysis/assessment split is conducted within each value of the status indicator. To demonstrate, Monte Carlo resampling is used where 75% of the data are in the analysis set. A total of 100 splits are created.   

```{r splits}
library(tidymodels)
set.seed(9666)
mc_samp <- mc_cv(lung, strata = status, times = 100, prop = 3/4)

cens_rate <- function(x) mean(analysis(x)$status == 1)
summary(map_dbl(mc_samp$splits, cens_rate))
```

To demonstrate the use of resampling with censored data, the parametric model shown above will be fit with different variable sets to characterize how important each predictor is to the outcome. 

To do this, a set of formulas are created for the different variable sets:

```{r forms}
three_fact <- Surv(time, status) ~ ph.ecog + age + strata(sex)
rm_ph.ecog <- Surv(time, status) ~           age + strata(sex)
rm_age     <- Surv(time, status) ~ ph.ecog +       strata(sex)
rm_sex     <- Surv(time, status) ~ ph.ecog + age              
```

To calculate the efficacy of the model, the concordance statistic is used (see `?concordance`). This function fits the model on the analysis set then measures performance on the assessment set: 

```{r concord}
get_concord <- function(split, ...) {
  lung_fit <- lung_spec %>% fit(..., data = analysis(split))
  pred_dat <- assessment(split)
  pred_dat <- bind_cols(pred_dat, predict(lung_fit, new_data = pred_dat))
  concordance(Surv(time, status) ~ .pred, pred_dat)$concordance
}
```

With this function, concordance statistics are created for each variable set.

```{r models}
mc_samp <- 
  mc_samp %>% 
  mutate(
    full    = map_dbl(splits, get_concord, form = three_fact),
    ph_ecog = map_dbl(splits, get_concord, form = rm_ph.ecog),
    age     = map_dbl(splits, get_concord, form = rm_age),
    sex     = map_dbl(splits, get_concord, form = rm_sex)
  )
```

These results are show the _drop_ in concordance when a predictor is removed. If the concordance statistic becomes smaller, the predictor was important to the model. 

```{r concord-df}
mc_samp %>%
  select(-splits) %>%
  pivot_longer(
    cols = c(-starts_with("id"),-full),
    names_to = "Removed",
    values_to = "Concordance"
  ) %>%
  mutate(Reduction = full - Concordance) %>%
  ggplot(aes(x = Reduction)) +
  geom_histogram(bins = 20) + 
  facet_wrap( ~ Removed) +
  geom_vline(xintercept = 0, lty = 2, col = "green") + 
  xlab("Drop in concordance when removed")
```

It looks as though the model missing `ph_ecog` has more of a loss in concordance values than the other models. As one might expect, the full model and the model absent `sex` are very similar; the difference in these models should only be the scale parameters estimates. 

# Comparing models more formally

To more formally test this, the `tidyposterior` package is used to create a Bayesian model for the concordance statistics. 

```{r perf-mod}
library(tidyposterior)
concord_est <- perf_mod(mc_samp, seed = 6507, iter = 5000)
```

The actual Bayesian model is:

```{r stan}
concord_est$stan
```

To summarize the posteriors of the mean parameters for each model:

```{r post}
concord_est %>% 
  tidy() %>% 
  as_tibble() %>% 
  ggplot(aes(x = posterior, col = model)) + 
  geom_line(stat = "density", trim = TRUE)
```

To compute the posteriors for the difference in models, the full model will be contrasted with the others:

```{r diffs}
comparisons <- contrast_models(
  concord_est, 
  list_1 = c("ph_ecog", "age", "sex"),
  list_2 = rep("full", 3),
  seed = 4654
  )
```

The posterior distributions show that, statistically, `ph_ecog` has real importance to the model. 

```{r diff-post}
ggplot(comparisons) +
  geom_vline(xintercept = 0, lty = 2, col = "green") + 
  xlab("Mean drop in concordance when removed")
summary(comparisons)
```

The effect of `sex` shouldn't be surprising since it only affected the scale parameter in the model. 


# Session information

```{r si, echo = FALSE}
small_session(pkgs)
```
 
