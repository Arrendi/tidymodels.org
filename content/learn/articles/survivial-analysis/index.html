---
title: "Survival Analysis Example"
tags: [survival, tidyposterior, survival analysis, regression models]
---

<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<script src="/rmarkdown-libs/elevate-section-attrs/elevate-section-attrs.js"></script>


<p>In addition to the <code>tidymodels</code> package, this example uses the <code>survival</code>, and <code>tidyposterior</code> packages.</p>
<p>In this article, a parametric analysis of censored data is conducted and <code>rsample</code> is used to measure the importance of predictors in the model. The data that will be used is the NCCTG lung cancer data contained in the <code>survival</code> package:</p>
<pre class="r"><code>library(survival)
str(lung)
#&gt; &#39;data.frame&#39;:    228 obs. of  10 variables:
#&gt;  $ inst     : num  3 3 3 5 1 12 7 11 1 7 ...
#&gt;  $ time     : num  306 455 1010 210 883 ...
#&gt;  $ status   : num  2 2 1 2 2 1 2 2 2 2 ...
#&gt;  $ age      : num  74 68 56 57 60 74 68 71 53 61 ...
#&gt;  $ sex      : num  1 1 1 1 1 1 2 2 1 1 ...
#&gt;  $ ph.ecog  : num  1 0 0 1 0 1 2 2 1 2 ...
#&gt;  $ ph.karno : num  90 90 90 90 100 50 70 60 70 70 ...
#&gt;  $ pat.karno: num  100 90 90 60 90 80 60 80 80 70 ...
#&gt;  $ meal.cal : num  1175 1225 NA 1150 NA ...
#&gt;  $ wt.loss  : num  NA 15 15 11 0 0 10 1 16 34 ...</code></pre>
<p><code>status</code> is an indicator for which patients are censored (<code>status = 1</code>) or an actual event (<code>status = 2</code>). The help file <code>?survreg</code> has the following model fit:</p>
<pre class="r"><code>lung_mod &lt;- survreg(Surv(time, status) ~ ph.ecog + age + strata(sex), data = lung)
summary(lung_mod)
#&gt; 
#&gt; Call:
#&gt; survreg(formula = Surv(time, status) ~ ph.ecog + age + strata(sex), 
#&gt;     data = lung)
#&gt;                Value Std. Error     z       p
#&gt; (Intercept)  6.73235    0.42396 15.88 &lt; 2e-16
#&gt; ph.ecog     -0.32443    0.08649 -3.75 0.00018
#&gt; age         -0.00581    0.00693 -0.84 0.40193
#&gt; sex=1       -0.24408    0.07920 -3.08 0.00206
#&gt; sex=2       -0.42345    0.10669 -3.97 7.2e-05
#&gt; 
#&gt; Scale:
#&gt; sex=1 sex=2 
#&gt; 0.783 0.655 
#&gt; 
#&gt; Weibull distribution
#&gt; Loglik(model)= -1137   Loglik(intercept only)= -1146
#&gt;  Chisq= 17.8 on 2 degrees of freedom, p= 0.00014 
#&gt; Number of Newton-Raphson Iterations: 5 
#&gt; n=227 (1 observation deleted due to missingness)</code></pre>
<p>Note that the stratification on gender only affects the scale parameter; the estimates above are from a log-linear model for the scale parameter even though they are listed with the regression variables for the other parameter. <code>coef</code> gives results that are more clear:</p>
<pre class="r"><code>coef(lung_mod)
#&gt; (Intercept)     ph.ecog         age 
#&gt;     6.73235    -0.32443    -0.00581</code></pre>
<p>To resample these data, it would be a good idea to try to maintain the same censoring rate across the splits. To do this, stratified resampling can be used where each analysis/assessment split is conducted within each value of the status indicator. To demonstrate, Monte Carlo resampling is used where 75% of the data are in the analysis set. A total of 100 splits are created.</p>
<pre class="r"><code>library(tidymodels)
set.seed(9666)
mc_samp &lt;- mc_cv(lung, strata = status, times = 100)

cens_rate &lt;- function(x) mean(analysis(x)$status == 1)
summary(map_dbl(mc_samp$splits, cens_rate))
#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#&gt;   0.279   0.279   0.279   0.279   0.279   0.279</code></pre>
<p>To demonstrate the use of resampling with censored data, the parametric model shown above will be fit with different variable sets to characterize how important each predictor is to the outcome.</p>
<p>To do this, a set of formulas are created for the different variable sets:</p>
<pre class="r"><code>three_fact &lt;- as.formula(Surv(time, status) ~ ph.ecog + age + strata(sex))
rm_ph.ecog &lt;- as.formula(Surv(time, status) ~           age + strata(sex))
rm_age     &lt;- as.formula(Surv(time, status) ~ ph.ecog +       strata(sex))
rm_sex     &lt;- as.formula(Surv(time, status) ~ ph.ecog + age              )</code></pre>
<p>The model fitting function will take the formula as an argument:</p>
<pre class="r"><code>mod_fit &lt;- function(x, form, ...) {
  survreg(form, data = analysis(x), ...)
}</code></pre>
<p>To calculate the efficacy of the model, the concordance statistic is used (see <code>?survConcordance</code>):</p>
<pre class="r"><code>get_concord &lt;- function(split, model, ...) {
  pred_dat &lt;- assessment(split)
  pred_dat$pred &lt;- predict(model, newdata = pred_dat)
  concordance(Surv(time, status) ~ pred, pred_dat, ...)$concordance
}</code></pre>
<p>With these functions, a series of models are created for each variable set.</p>
<pre class="r"><code>mc_samp &lt;- 
  mc_samp %&gt;% 
  mutate(
    full_mod    = map(splits, mod_fit, form = three_fact),
    ph_ecog_mod = map(splits, mod_fit, form = rm_ph.ecog),
    age_mod     = map(splits, mod_fit, form = rm_age),
    sex_mod     = map(splits, mod_fit, form = rm_sex)
  )</code></pre>
<p>Similarly, the concordance values are computed for each model:</p>
<pre class="r"><code>mc_samp &lt;- 
  mc_samp %&gt;% 
  mutate(
    full    = map2_dbl(splits, full_mod, get_concord),
    ph_ecog = map2_dbl(splits, ph_ecog_mod, get_concord),
    age     = map2_dbl(splits, age_mod, get_concord),
    sex     = map2_dbl(splits, sex_mod, get_concord)
  )</code></pre>
<p>The results are:</p>
<pre class="r"><code>concord_est &lt;- 
  mc_samp %&gt;%
  dplyr::select(-ends_with(&quot;mod&quot;)) 

concord_est %&gt;% 
  select(-splits) %&gt;% 
  pivot_longer(cols = c(-starts_with(&quot;id&quot;)), names_to = &quot;Removed&quot;, values_to = &quot;Concordance&quot;) %&gt;% 
  ggplot(aes(x = reorder(Removed, Concordance), y = Concordance)) + 
  geom_line(aes(group = id), alpha = .3) + 
  xlab(&quot;Predictor Removed&quot;)</code></pre>
<p><img src="/examples/survivial-analysis/index_files/figure-html/concord-df-1.png" width="672" /></p>
<p>It looks as though the model missing <code>ph_ecog</code> has more of a loss in concordance values than the other models. As one might expect, the full model and the model absent <code>sex</code> are very similar; the difference in these models should only be the scale parameters estimates.</p>
<p>To more formally test this, the <code>tidyposterior</code> package is used to create a Bayesian model for the concordance statistics.</p>
<p>The actual Bayesian model is:</p>
<pre class="r"><code>concord_est$stan
#&gt; stan_glmer
#&gt;  family:       gaussian [identity]
#&gt;  formula:      statistic ~ model + (1 | id)
#&gt;  observations: 400
#&gt; ------
#&gt;              Median MAD_SD
#&gt; (Intercept)   0.6    0.0  
#&gt; modelph_ecog -0.1    0.0  
#&gt; modelage      0.0    0.0  
#&gt; modelsex      0.0    0.0  
#&gt; 
#&gt; Auxiliary parameter(s):
#&gt;       Median MAD_SD
#&gt; sigma 0.0    0.0   
#&gt; 
#&gt; Error terms:
#&gt;  Groups   Name        Std.Dev.
#&gt;  id       (Intercept) 0.033   
#&gt;  Residual             0.030   
#&gt; Num. levels: id 100 
#&gt; 
#&gt; ------
#&gt; * For help interpreting the printed output see ?print.stanreg
#&gt; * For info on the priors used see ?prior_summary.stanreg</code></pre>
<p>To summarize the posteriors for each model:</p>
<pre class="r"><code>concord_est %&gt;% 
  tidy() %&gt;% 
  as_tibble() %&gt;% 
  ggplot(aes(x = posterior, col = model)) + 
  geom_line(stat = &quot;density&quot;, trim = TRUE)</code></pre>
<p><img src="/examples/survivial-analysis/index_files/figure-html/post-1.png" width="672" /></p>
<p>To compute the posteriors for the difference in models, the full model will be contrasted with the others:</p>
<pre class="r"><code>comparisons &lt;- contrast_models(
  concord_est, 
  list_1 = rep(&quot;full&quot;, 3),
  list_2 = c(&quot;ph_ecog&quot;, &quot;age&quot;, &quot;sex&quot;),
  seed = 4654
  )</code></pre>
<p>The posterior distributions show that, statistically, <code>ph_ecog</code> has real importance to the model.</p>
<pre class="r"><code>ggplot(comparisons) + 
  theme_bw()</code></pre>
<p><img src="/examples/survivial-analysis/index_files/figure-html/diff-post-1.png" width="672" /></p>
<pre class="r"><code>summary(comparisons)
#&gt; # A tibble: 3 x 9
#&gt;   contrast probability     mean    lower   upper  size pract_neg pract_equiv
#&gt;   &lt;chr&gt;          &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
#&gt; 1 full vs…       0.634  0.00146 -0.00535 0.00837     0        NA          NA
#&gt; 2 full vs…       1      0.0524   0.0454  0.0594      0        NA          NA
#&gt; 3 full vs…       0.370 -0.00142 -0.00833 0.00550     0        NA          NA
#&gt; # … with 1 more variable: pract_pos &lt;dbl&gt;</code></pre>
<p>The effect of <code>sex</code> shouldn’t be suprising since it only affected the scale parameter in the model.</p>
